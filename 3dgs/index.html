<!doctype html>
<html>

<head>
  <title>The Art of Sound Forms</title>
  <link rel="icon" type="image/png" href="/img/favicon.png" />
  <link rel="stylesheet" href="/common.css" />
  <link rel="stylesheet" href="3dgs.css" />
</head>

<body>
  <h1 style="margin-bottom:0; display:none">
    <a href="/">Pra<span>sound</span></a>
  </h1>

  <div class="wave_spanner" style="display:none">
    <img src="/img/formula_div.png">
    <img src="/img/formula.png">
  </div>

  <canvas id="webgl"></canvas>
  <code id="codemirror" class="debug"></code>

  <div id="controls">
    <button id="audio" title="Upload audio" class="debug"><img src="/img/ico/mic.png"></button>
    <button id="download" title="Download .PLY" class="debug"><img src="/img/ico/file.png"></button>
  </div>

  <script id="vert-glsl" type="x-shader/x-vertex">
    out vec2 vUv;

    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
    }
  </script>

  <script id="blur-glsl" type="x-shader/x-fragment">
    uniform sampler2D tDiffuse;
    uniform  float iTime;
    in vec2 vUv;
    
    float hash( vec2 p ) {
      return fract(sin(dot(p, vec2(41, 289)))*45758.5453);
    }
 
    vec4 radialBlur(sampler2D img, vec2 uv) {
        float SAMPLES = 24.;
        float decay = 0.97; 
        float density = 0.5; 
        float weight = 0.1; 
        
        vec2 tuv =  uv - .5;
        vec2 dTuv = tuv*density/SAMPLES;
        vec4 col = texture(img, uv);
        uv += dTuv*(hash(uv + fract(iTime))*2. - 1.);
        
        for(float i = 0.; i < SAMPLES; i++){
            uv -= dTuv;
            vec4 src = texture(img, uv);
            col += weight * pow(src, vec4(8));
            weight *= decay;
        }
        
        col *= 1. - dot(tuv, tuv)*.75;
        return sqrt(smoothstep(0., 1., col));
    }

    void main() {
      gl_FragColor = radialBlur(tDiffuse, vUv);
    }
  </script>

  <script id="vignette-glsl" type="x-shader/x-fragment">
    uniform sampler2D tDiffuse;
    in vec2 vUv;

    float vignette() {
        vec2 uv = vUv;
        uv.xy *= 1. - uv.yx;
        float v = uv.x * uv.y * 15.0;
        return pow(v, 0.125);
    }

    void main() {
      vec4 o = texture(tDiffuse, vUv);
      gl_FragColor = o*vignette();
      gl_FragColor.a = 1.0;
    }
  </script>

  <script id="tonemapping-glsl" type="x-shader/x-fragment">
    uniform sampler2D tDiffuse;
    in vec2 vUv;

    void main() {
      vec4 o = texture(tDiffuse, vUv);
      gl_FragColor = tanh(o*o);
    }
  </script>

  <script type="importmap">
    {
      "imports": {
        "three": "/lib/three/three.module.js",
        "three/addons/": "/lib/three/examples/jsm/",
        "@sparkjsdev/spark": "/lib/spark.module.js",
        "@codemirror/view": "/lib/codemirror/@codemirror_view.js",
        "@codemirror/language": "/lib/codemirror/chunk-MED5PSS5.js",
        "@lezer/highlight": "/lib/codemirror/chunk-MED5PSS5.js"
      }
    }
  </script>

  <script type="module" src="3dgs.js"></script>
</body>

</html>